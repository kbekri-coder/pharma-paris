<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte interactive - Pharmacies et R√©seaux ferr√©s √† Paris</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    #map { height: 90vh; width: 100%; }
    #controls { padding: 8px; }
    #controls > * { margin-right: 8px; }
    #counter { font-weight: bold; }
    .num-pin {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      border: 2px solid #fff;
      box-shadow: 0 0 2px rgba(0,0,0,.5);
    }
  </style>
</head>
<body>
  <div id="controls">
    <input id="csvInput" type="file" accept=".csv" />
    <button id="loadCsvBtn">Charger CSV (local)</button>
    <span id="counter">Vus: 0 / Total: 0</span>
    <span id="saveStatus" style="margin-left:8px;color:#2c7"></span>
    <button id="saveCsvBtn">Enregistrer CSV (mis √† jour)</button>
    <button id="openPickerBtn">Ouvrir (acc√®s direct)</button>
    <button id="savePickerBtn">Enregistrer (acc√®s direct)</button>
  </div>
  <div id="map"></div>
  <!-- Fallback statique: on embarque le CSV via un <object> lisible c√¥t√© client -->
  <object id="csvObject" data="pharmacies_paris_traite_avec_adresses.csv" type="text/plain" style="display:none"></object>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialisation de la carte
    const map = L.map('map').setView([48.8566, 2.3522], 12);

    // Fond de carte
    const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Couche Pharmacies
    const pharmacyLayer = L.layerGroup().addTo(map);
    const pharmacyData = []; // { marker, properties, lon, lat }
    let originalRows = [];   // lignes originales du CSV (objets)
    let originalFields = []; // en-t√™tes d'origine (ordre pr√©serv√©)
    let sourceFileName = 'pharmacies_paris_traite_avec_adresses.csv';
    let fileHandle = null;   // handle du fichier ouvert via File System Access API
    const DEFAULT_CSV = 'pharmacies_paris_traite_avec_adresses.csv';

    function updateCounter() {
      const total = pharmacyData.length;
      const vus = pharmacyData.reduce((acc, f) => acc + (String(f.properties.VUE||'').toLowerCase()==='oui' ? 1:0), 0);
      const el = document.getElementById('counter');
      if (el) el.textContent = `Vus: ${vus} / Total: ${total}`;
    }

    // Style marqueur selon VUE
    function markerStyleByVue(vue) {
      const isVue = String(vue || '').trim().toLowerCase() === 'oui';
      return {
        radius: 6,
        color: isVue ? '#c0392b' : '#1e7e34',
        fillColor: isVue ? '#e74c3c' : '#28a745',
        fillOpacity: 0.9,
        weight: 2
      };
    }

    function makePopupContent(p) {
      const name = p.name || 'Nom inconnu';
      const phone = p.phone || 'Non renseign√©';
      const addr = p.address || 'Adresse non renseign√©e';
      const vue = (p.VUE || 'non');
      const num = p.index != null ? `#${p.index} ¬∑ ` : '';
      return `<b>Pharmacie</b><br>${num}${name}<br>üìç ${addr}<br>üìû ${phone}<br>VUE: <b>${vue}</b><br><button class="toggle-vue-btn">Basculer VUE</button><button class="save-vue-btn" style="margin-left:8px">Enregistrer</button>`;
    }

    function buildNumberedIcon(props) {
      const isVue = String(props.VUE||'').trim().toLowerCase()==='oui';
      const bg = isVue ? '#e74c3c' : '#28a745';
      const html = `<div class="num-pin" style="background:${bg}">${props.index}</div>`;
      return L.divIcon({
        className: '',
        html,
        iconSize: [22,22],
        iconAnchor: [11,11],
        popupAnchor: [0,-12]
      });
    }

    function refreshMarkerIcon(item) {
      item.marker.setIcon(buildNumberedIcon(item.properties));
    }

    function addPharmacyPoint(lon, lat, props) {
      const marker = L.marker([lat, lon], { icon: buildNumberedIcon(props) })
        .bindPopup(makePopupContent(props));
      marker.on('popupopen', (e) => {
        const wireHandlers = () => {
          const btn = e.popup._contentNode.querySelector('.toggle-vue-btn');
          if (btn) {
            btn.onclick = () => {
              props.VUE = (String(props.VUE||'non').toLowerCase()==='oui') ? 'non' : 'oui';
              refreshMarkerIcon({ marker, properties: props });
              marker.setPopupContent(makePopupContent(props));
              updateCounter();
              // R√©-attacher les handlers sur le nouveau contenu
              setTimeout(wireHandlers, 0);
            };
          }
          const saveBtn = e.popup._contentNode.querySelector('.save-vue-btn');
          if (saveBtn) {
            saveBtn.onclick = async () => {
              const setStatus = (t, ok=true) => {
                const s = document.getElementById('saveStatus');
                if (s) { s.style.color = ok ? '#2c7' : '#c00'; s.textContent = t; setTimeout(()=>{ s.textContent=''; }, 2000); }
              };
              try {
                const idx = props.rowIndex;
                if (idx != null && originalRows[idx]) {
                  originalRows[idx]['VUE'] = props.VUE || 'non';
                }
                if (fileHandle) {
                  const csv = buildUpdatedCSV();
                  const writable = await fileHandle.createWritable();
                  await writable.write(csv);
                  await writable.close();
                  setStatus('Enregistr√© ‚úî');
                } else {
                  const csv = buildUpdatedCSV();
                  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                  const a = document.createElement('a');
                  const url = URL.createObjectURL(blob);
                  a.href = url;
                  const base = sourceFileName.replace(/\.csv$/i, '');
                  a.download = `${base}_updated.csv`;
                  a.style.display = 'none';
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                  setStatus('Export√© (mise √† jour)');
                }
              } catch(e) {
                console.error(e);
                setStatus('Erreur d\'enregistrement', false);
              }
            };
          }
        };
        wireHandlers();
      });
      pharmacyLayer.addLayer(marker);
      return marker;
    }

    function parseCoord(str) {
      if (!str) return null;
      const parts = String(str).split(',');
      if (parts.length < 2) return null;
      const lat = parseFloat(parts[0]);
      const lon = parseFloat(parts[1]);
      if (Number.isNaN(lat) || Number.isNaN(lon)) return null;
      return { lat, lon };
    }

    function loadCsvText(csvText) {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
          pharmacyLayer.clearLayers();
          pharmacyData.length = 0;
          const rows = res.data || [];
          originalRows = rows.map(r => ({...r}));
          originalFields = Array.isArray(res.meta?.fields) ? [...res.meta.fields] : [];
          if (!originalFields.includes('VUE')) originalFields.push('VUE');

          const added = [];
          let displayIndex = 1;
          rows.forEach((row, rowIndex) => {
            const coord = parseCoord(row['Coordonnees']);
            if (!coord) return;
            const props = {
              name: row['Pharmacie'] || 'Nom inconnu',
              phone: row['Telephone'] || 'Non renseign√©',
              address: row['Adresse_Complete'] || '',
              VUE: (row['VUE'] && String(row['VUE']).trim()) ? String(row['VUE']).trim() : 'non',
              index: displayIndex,
              rowIndex
            };
            const marker = addPharmacyPoint(coord.lon, coord.lat, props);
            added.push(marker);
            pharmacyData.push({ marker, properties: props, lon: coord.lon, lat: coord.lat });
            displayIndex += 1;
          });
          if (added.length > 0) {
            map.fitBounds(L.featureGroup(added).getBounds().pad(0.1));
          }
          updateCounter();
        }
      });
    }

    // Tenter de charger par d√©faut le CSV situ√© au m√™me niveau que cette page
    async function tryLoadDefault() {
      try {
        const resp = await fetch(DEFAULT_CSV, { cache: 'no-store' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const text = await resp.text();
        sourceFileName = DEFAULT_CSV;
        loadCsvText(text);
      } catch (e) {
        // Fallback ultra-statqiue: lire le contenu de l'<object> si accessible en file://
        try {
          const obj = document.getElementById('csvObject');
          const readObject = () => {
            const doc = obj && obj.contentDocument;
            const body = doc && doc.body;
            const text = body && (body.innerText || body.textContent);
            if (text && text.trim().length > 0) {
              sourceFileName = DEFAULT_CSV;
              loadCsvText(text);
              return true;
            }
            return false;
          };
          // Si d√©j√† charg√©
          if (!readObject()) {
            // Attendre l'√©v√©nement de chargement
            obj.addEventListener('load', () => { readObject(); }, { once: true });
          }
        } catch(err) {
          console.warn('Fallback <object> non accessible:', err);
        }
      }
    }

    // Enregistrer/exporter le CSV mis √† jour (avec VUE modifi√©e depuis la carte)
    function downloadUpdatedCSV() {
      // R√©injecter VUE dans les lignes originales selon rowIndex
      pharmacyData.forEach(item => {
        const idx = item.properties.rowIndex;
        if (idx != null && originalRows[idx]) {
          originalRows[idx]['VUE'] = item.properties.VUE || 'non';
        }
      });

      const csv = Papa.unparse({
        fields: originalFields,
        data: originalRows
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      const base = sourceFileName.replace(/\.csv$/i, '');
      a.download = `${base}_updated.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function saveUpdatedCSVToHandle() {
      if (!fileHandle) {
        alert("Aucun fichier ouvert via acc√®s direct.");
        return;
      }
      // R√©injecter VUE dans originalRows
      pharmacyData.forEach(item => {
        const idx = item.properties.rowIndex;
        if (idx != null && originalRows[idx]) {
          originalRows[idx]['VUE'] = item.properties.VUE || 'non';
        }
      });
      const csv = Papa.unparse({ fields: originalFields, data: originalRows });
      try {
        const writable = await fileHandle.createWritable();
        await writable.write(csv);
        await writable.close();
        alert('Fichier enregistr√©.');
      } catch (e) {
        console.error(e);
        alert("Impossible d'enregistrer le fichier (permissions ?)");
      }
    }

    // Chargement CSV local (sans serveur) via input file
    document.getElementById('loadCsvBtn').addEventListener('click', () => {
      const input = document.getElementById('csvInput');
      const file = input.files && input.files[0];
      if (!file) {
        alert('S√©lectionnez d\'abord le fichier pharmacies_paris_traite_avec_adresses.csv');
        return;
      }
      sourceFileName = file.name || sourceFileName;
      const reader = new FileReader();
      reader.onload = (e) => loadCsvText(e.target.result);
      reader.readAsText(file, 'utf-8');
    });

    document.getElementById('saveCsvBtn').addEventListener('click', () => {
      if (!originalRows.length) {
        alert('Chargez d\'abord un CSV.');
        return;
      }
      downloadUpdatedCSV();
    });

    // File System Access API - ouvrir/enregistrer sans t√©l√©chargement
    const openPickerBtn = document.getElementById('openPickerBtn');
    const savePickerBtn = document.getElementById('savePickerBtn');
    const hasFSA = ('showOpenFilePicker' in window) && ('showSaveFilePicker' in window || 'createWritable' in (window.FileSystemFileHandle||{}));
    if (!hasFSA) {
      savePickerBtn.disabled = true;
      savePickerBtn.title = 'Non support√© par ce navigateur';
    }

    openPickerBtn.addEventListener('click', async () => {
      try {
        if (!('showOpenFilePicker' in window)) throw new Error('FSA non support√©e');
        const [handle] = await window.showOpenFilePicker({
          types: [{ description: 'CSV', accept: { 'text/csv': ['.csv'] } }]
        });
        fileHandle = handle;
        const file = await handle.getFile();
        sourceFileName = file.name || sourceFileName;
        const text = await file.text();
        loadCsvText(text);
      } catch (e) {
        console.warn(e);
      }
    });

    savePickerBtn.addEventListener('click', async () => {
      if (!originalRows.length) {
        alert('Chargez d\'abord un CSV.');
        return;
      }
      if (!fileHandle && 'showSaveFilePicker' in window) {
        try {
          fileHandle = await window.showSaveFilePicker({
            suggestedName: sourceFileName,
            types: [{ description: 'CSV', accept: { 'text/csv': ['.csv'] } }]
          });
        } catch (e) {
          console.warn(e);
        }
      }
      await saveUpdatedCSVToHandle();
    });

    // Couche R√©seaux ferr√©s
    const railLayer = L.layerGroup().addTo(map);

    // R√©cup√©ration du r√©seau ferr√© (railway=subway/light_rail/rail)
    fetch("https://overpass-api.de/api/interpreter?data=[out:json][timeout:50];area['name'='Paris']->.searchArea;way['railway'~'subway|light_rail|rail'](area.searchArea);out geom;")
      .then(r => r.json())
      .then(data => {
        (data.elements || []).forEach(el => {
          if (el.type === "way" && el.geometry) {
            const coords = el.geometry.map(p => [p.lat, p.lon]);
            const polyline = L.polyline(coords, {color: "red", weight: 2})
              .bindPopup("<b>R√©seau ferr√©</b><br>" + (el.tags?.name || "Ligne ferroviaire"));
            railLayer.addLayer(polyline);
          }
        });
      })
      .catch(() => {
        // Offline ou √©chec r√©seau: ignorer proprement
      });

    // Contr√¥les des couches
    L.control.layers(
      {"OpenStreetMap": baseOSM},
      {"Pharmacies": pharmacyLayer, "R√©seaux ferr√©s": railLayer},
      {collapsed: false}
    ).addTo(map);

    // Essai de chargement automatique du CSV local (m√™me dossier)
    tryLoadDefault();
  </script>
</body>
</html>
